# –ú–∞—Å—Å–æ–≤—ã–π –ø–æ–∏—Å–∫ –ø–æ—Ö–æ–∂–∏—Ö —Ç–æ–≤–∞—Ä–æ–≤ –ø–æ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è–º

–ê–≤—Ç–æ–º–∞—Ç–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –ø–æ–∏—Å–∫ –ø–æ—Ö–æ–∂–∏—Ö —Ç–æ–≤–∞—Ä–æ–≤ –Ω–∞ Ozon.ru –ø–æ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è–º —á–µ—Ä–µ–∑ Safari.

## –í–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏

- ‚úÖ –ó–∞–≥—Ä—É–∑–∫–∞ —Ç–æ–≤–∞—Ä–æ–≤ –∏–∑ MongoDB –∏–ª–∏ JSON —Ñ–∞–π–ª–∞
- ‚úÖ –ü–æ–∏—Å–∫ –ø–æ—Ö–æ–∂–∏—Ö —Ç–æ–≤–∞—Ä–æ–≤ –¥–ª—è –∫–∞–∂–¥–æ–≥–æ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è
- ‚úÖ –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ –≤ JSON –∏ MongoDB
- ‚úÖ –ü—Ä–æ–≥—Ä–µ—Å—Å —Å –∞–≤—Ç–æ—Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ–º –ø–æ—Å–ª–µ –∫–∞–∂–¥–æ–≥–æ –ø–æ–∏—Å–∫–∞
- ‚úÖ –ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º–∞—è –∑–∞–¥–µ—Ä–∂–∫–∞ –º–µ–∂–¥—É –∑–∞–ø—Ä–æ—Å–∞–º–∏
- ‚úÖ –ü–æ–¥–¥–µ—Ä–∂–∫–∞ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞ —Ç–æ–≤–∞—Ä–æ–≤ –¥–ª—è —Ç–µ—Å—Ç–∞

## –¢—Ä–µ–±–æ–≤–∞–Ω–∏—è

1. **Safari —Å –≤–∫–ª—é—á–µ–Ω–Ω—ã–º JavaScript –æ—Ç Apple Events:**
   ```bash
   defaults write com.apple.Safari AllowJavaScriptFromAppleEvents -bool true
   ```

2. **Node.js –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏:**
   ```bash
   npm install mongodb
   ```

## –°—Ç—Ä—É–∫—Ç—É—Ä–∞ —Ñ–∞–π–ª–æ–≤

- `bulk_image_search.js` - –û—Å–Ω–æ–≤–Ω–æ–π —Å–∫—Ä–∏–ø—Ç –º–∞—Å—Å–æ–≤–æ–≥–æ –ø–æ–∏—Å–∫–∞
- `ozon_image_search.applescript` - Safari automation —Å–∫—Ä–∏–ø—Ç
- `save_to_mongodb.js` - –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ –≤ MongoDB
- `products_test.json` - –¢–µ—Å—Ç–æ–≤—ã–π –Ω–∞–±–æ—Ä —Ç–æ–≤–∞—Ä–æ–≤ (3 —à—Ç)

## –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ

### 1. –ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ –¥–∞–Ω–Ω—ã—Ö

#### –í–∞—Ä–∏–∞–Ω—Ç A: –≠–∫—Å–ø–æ—Ä—Ç –∏–∑ MongoDB

```bash
# –≠–∫—Å–ø–æ—Ä—Ç –≤—Å–µ—Ö —Ç–æ–≤–∞—Ä–æ–≤ —Å –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è–º–∏
mongoexport \
  --uri="mongodb://localhost:27017/ozon" \
  --collection=products \
  --query='{"images": {"$exists": true, "$ne": []}}' \
  --out=products.json
```

#### –í–∞—Ä–∏–∞–Ω—Ç B: –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å —Ç–µ—Å—Ç–æ–≤—ã–π —Ñ–∞–π–ª

```bash
# –£–∂–µ –µ—Å—Ç—å: products_test.json (3 —Ç–æ–≤–∞—Ä–∞)
```

### 2. –ó–∞–ø—É—Å–∫ –º–∞—Å—Å–æ–≤–æ–≥–æ –ø–æ–∏—Å–∫–∞

```bash
cd /Users/mikhailzhirnov/claude/ozonparser/js

# –¢–µ—Å—Ç –Ω–∞ 3 —Ç–æ–≤–∞—Ä–∞—Ö
PRODUCTS_FILE=products_test.json LIMIT=3 node bulk_image_search.js

# –ü–æ–ª–Ω—ã–π –∑–∞–ø—É—Å–∫ (–≤—Å–µ —Ç–æ–≤–∞—Ä—ã –∏–∑ products.json)
PRODUCTS_FILE=products.json node bulk_image_search.js

# –° –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ–º (–ø–µ—Ä–≤—ã–µ 10 —Ç–æ–≤–∞—Ä–æ–≤)
PRODUCTS_FILE=products.json LIMIT=10 node bulk_image_search.js

# –° —É–≤–µ–ª–∏—á–µ–Ω–Ω–æ–π –∑–∞–¥–µ—Ä–∂–∫–æ–π –º–µ–∂–¥—É –ø–æ–∏—Å–∫–∞–º–∏ (10 —Å–µ–∫—É–Ω–¥)
PRODUCTS_FILE=products.json DELAY_MS=10000 node bulk_image_search.js
```

### 3. –†–µ–∑—É–ª—å—Ç–∞—Ç—ã

–†–µ–∑—É–ª—å—Ç–∞—Ç—ã —Å–æ—Ö—Ä–∞–Ω—è—é—Ç—Å—è –≤ `image_search_results.json`:

```json
{
  "total_processed": 3,
  "total_products": 3,
  "success_count": 3,
  "fail_count": 0,
  "results": [
    {
      "source_product": {
        "id": "7249026173",
        "title": "–ú–∞—Å—Å–∞–∂–µ—Ä –¥–ª—è –≥–ª–∞–∑...",
        "image": "https://ir.ozone.ru/...",
        "price": 1990,
        "url": "https://www.ozon.ru/..."
      },
      "search_result": {
        "success": true,
        "total_count": 25,
        "products": [
          {
            "index": 1,
            "id": "1830612489",
            "title": "–ú–∞—Å—Å–∞–∂–µ—Ä –¥–ª—è –ª–∏—Ü–∞ –∏ –≥–ª–∞–∑...",
            "url": "https://www.ozon.ru/product/..."
          }
        ]
      },
      "searched_at": "2025-11-01T16:45:00.000Z"
    }
  ]
}
```

### 4. –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –≤ MongoDB

```bash
# –°–æ—Ö—Ä–∞–Ω–∏—Ç—å —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã –≤ MongoDB
MONGODB_URI="mongodb://localhost:27017" \
MONGO_DB="ozon" \
MONGO_COLLECTION="image_search_results" \
RESULTS_FILE="./image_search_results.json" \
node save_to_mongodb.js
```

## –ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è

### bulk_image_search.js

| –ü–µ—Ä–µ–º–µ–Ω–Ω–∞—è | –û–ø–∏—Å–∞–Ω–∏–µ | –ü–æ —É–º–æ–ª—á–∞–Ω–∏—é |
|------------|----------|--------------|
| `PRODUCTS_FILE` | –ü—É—Ç—å –∫ JSON —Å —Ç–æ–≤–∞—Ä–∞–º–∏ | `./products.json` |
| `LIMIT` | –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ —Ç–æ–≤–∞—Ä–æ–≤ –¥–ª—è –æ–±—Ä–∞–±–æ—Ç–∫–∏ (0 = –≤—Å–µ) | `0` |
| `DELAY_MS` | –ó–∞–¥–µ—Ä–∂–∫–∞ –º–µ–∂–¥—É –ø–æ–∏—Å–∫–∞–º–∏ (–º—Å) | `5000` |

### save_to_mongodb.js

| –ü–µ—Ä–µ–º–µ–Ω–Ω–∞—è | –û–ø–∏—Å–∞–Ω–∏–µ | –ü–æ —É–º–æ–ª—á–∞–Ω–∏—é |
|------------|----------|--------------|
| `MONGODB_URI` | MongoDB connection string | `mongodb://localhost:27017` |
| `MONGO_DB` | –ò–º—è –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö | `ozon` |
| `MONGO_COLLECTION` | –ò–º—è –∫–æ–ª–ª–µ–∫—Ü–∏–∏ | `image_search_results` |
| `RESULTS_FILE` | –ü—É—Ç—å –∫ —Ñ–∞–π–ª—É —Å —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞–º–∏ | `./image_search_results.json` |

## –§–æ—Ä–º–∞—Ç –≤—Ö–æ–¥–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö

JSON —Ñ–∞–π–ª —Å –º–∞—Å—Å–∏–≤–æ–º —Ç–æ–≤–∞—Ä–æ–≤:

```json
[
  {
    "id": "123456",
    "title": "–ù–∞–∑–≤–∞–Ω–∏–µ —Ç–æ–≤–∞—Ä–∞",
    "images": ["https://ir.ozone.ru/..."],
    "price": 1990,
    "url": "https://www.ozon.ru/product/..."
  }
]
```

–ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ–º—ã–µ –ø–æ–ª—è –¥–ª—è –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π (–≤ –ø–æ—Ä—è–¥–∫–µ –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç–∞):
- `images` (–º–∞—Å—Å–∏–≤)
- `image` (—Å—Ç—Ä–æ–∫–∞)
- `picture` (—Å—Ç—Ä–æ–∫–∞)
- `photo` (—Å—Ç—Ä–æ–∫–∞)

## –°—Ç—Ä—É–∫—Ç—É—Ä–∞ MongoDB

### –ö–æ–ª–ª–µ–∫—Ü–∏—è: `image_search_results`

```javascript
{
  _id: ObjectId("..."),
  source_product: {
    id: "7249026173",
    title: "–ú–∞—Å—Å–∞–∂–µ—Ä –¥–ª—è –≥–ª–∞–∑",
    image: "https://ir.ozone.ru/...",
    price: 1990,
    url: "https://www.ozon.ru/..."
  },
  search_result: {
    success: true,
    total_count: 25,
    products: [
      {
        index: 1,
        id: "1830612489",
        title: "–ú–∞—Å—Å–∞–∂–µ—Ä –¥–ª—è –ª–∏—Ü–∞...",
        url: "https://www.ozon.ru/..."
      }
    ]
  },
  searched_at: ISODate("2025-11-01T16:45:00.000Z"),
  updated_at: ISODate("2025-11-01T16:45:00.000Z")
}
```

### –ò–Ω–¥–µ–∫—Å—ã

- `source_product.id` (unique) - –¥–ª—è –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–µ–Ω–∏—è –¥—É–±–ª–∏–∫–∞—Ç–æ–≤

## –ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å

- **Safari**: —Ç—Ä–µ–±—É–µ—Ç ~20-25 —Å–µ–∫—É–Ω–¥ –Ω–∞ –æ–¥–∏–Ω –ø–æ–∏—Å–∫ (–æ—Ç–∫—Ä—ã—Ç–∏–µ, –∫–ª–∏–∫–∏, –∑–∞–≥—Ä—É–∑–∫–∞)
- **–ó–∞–¥–µ—Ä–∂–∫–∞**: —Ä–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è 5-10 —Å–µ–∫—É–Ω–¥ –º–µ–∂–¥—É –ø–æ–∏—Å–∫–∞–º–∏
- **–°–∫–æ—Ä–æ—Å—Ç—å**: ~3-6 —Ç–æ–≤–∞—Ä–æ–≤ –≤ –º–∏–Ω—É—Ç—É
- **100 —Ç–æ–≤–∞—Ä–æ–≤**: ~20-30 –º–∏–Ω—É—Ç
- **1000 —Ç–æ–≤–∞—Ä–æ–≤**: ~3-5 —á–∞—Å–æ–≤

## –ü—Ä–∏–º–µ—Ä—ã –∑–∞–ø—É—Å–∫–∞

### –ë—ã—Å—Ç—Ä—ã–π —Ç–µ—Å—Ç (3 —Ç–æ–≤–∞—Ä–∞)
```bash
PRODUCTS_FILE=products_test.json node bulk_image_search.js
```

### –ü–µ—Ä–≤—ã–µ 20 —Ç–æ–≤–∞—Ä–æ–≤ –∏–∑ –±–∞–∑—ã
```bash
mongoexport --uri="mongodb://localhost:27017/ozon" \
  --collection=products \
  --query='{"images": {"$exists": true}}' \
  --limit=20 \
  --out=products_20.json

PRODUCTS_FILE=products_20.json node bulk_image_search.js
```

### –ü–æ–ª–Ω—ã–π –∑–∞–ø—É—Å–∫ —Å —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ–º –≤ MongoDB
```bash
# 1. –≠–∫—Å–ø–æ—Ä—Ç —Ç–æ–≤–∞—Ä–æ–≤
mongoexport --uri="mongodb://localhost:27017/ozon" \
  --collection=products \
  --out=products_all.json

# 2. –ú–∞—Å—Å–æ–≤—ã–π –ø–æ–∏—Å–∫
PRODUCTS_FILE=products_all.json node bulk_image_search.js

# 3. –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –≤ MongoDB
MONGODB_URI="mongodb://localhost:27017" node save_to_mongodb.js
```

## –£—Å—Ç—Ä–∞–Ω–µ–Ω–∏–µ –ø—Ä–æ–±–ª–µ–º

### Safari –Ω–µ –æ—Ç–∫—Ä—ã–≤–∞–µ—Ç—Å—è

–ü—Ä–æ–≤–µ—Ä—å—Ç–µ –Ω–∞—Å—Ç—Ä–æ–π–∫—É:
```bash
defaults read com.apple.Safari AllowJavaScriptFromAppleEvents
# –î–æ–ª–∂–Ω–æ –≤–µ—Ä–Ω—É—Ç—å: 1
```

### –û—à–∏–±–∫–∞ "No camera button"

- –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ ozon.ru –ø–æ–ª–Ω–æ—Å—Ç—å—é –∑–∞–≥—Ä—É–∑–∏–ª—Å—è
- –£–≤–µ–ª–∏—á—å—Ç–µ –∑–∞–¥–µ—Ä–∂–∫—É –≤ `ozon_image_search.applescript` (delay –ø–æ—Å–ª–µ –∑–∞–≥—Ä—É–∑–∫–∏ —Å—Ç—Ä–∞–Ω–∏—Ü—ã)

### –†–µ–∑—É–ª—å—Ç–∞—Ç—ã –Ω–µ —Å–æ—Ö—Ä–∞–Ω—è—é—Ç—Å—è

- –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ø—Ä–∞–≤–∞ –Ω–∞ –∑–∞–ø–∏—Å—å –≤ —Ç–µ–∫—É—â—É—é –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é
- –†–µ–∑—É–ª—å—Ç–∞—Ç—ã —Å–æ—Ö—Ä–∞–Ω—è—é—Ç—Å—è –ø–æ—Å–ª–µ –∫–∞–∂–¥–æ–≥–æ –ø–æ–∏—Å–∫–∞ –≤ `image_search_results.json`

### –°–ª–∏—à–∫–æ–º –±—ã—Å—Ç—Ä–æ / –º–µ–¥–ª–µ–Ω–Ω–æ

–ù–∞—Å—Ç—Ä–æ–π—Ç–µ –∑–∞–¥–µ—Ä–∂–∫—É:
```bash
# –ë—ã—Å—Ç—Ä–µ–µ (–º–∏–Ω–∏–º—É–º 3 —Å–µ–∫—É–Ω–¥—ã)
DELAY_MS=3000 node bulk_image_search.js

# –ú–µ–¥–ª–µ–Ω–Ω–µ–µ (–¥–ª—è —Å—Ç–∞–±–∏–ª—å–Ω–æ—Å—Ç–∏)
DELAY_MS=10000 node bulk_image_search.js
```

## –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –ø—Ä–æ–≥—Ä–µ—Å—Å–∞

–°–∫—Ä–∏–ø—Ç –≤—ã–≤–æ–¥–∏—Ç –ø–æ–¥—Ä–æ–±–Ω—ã–π –ª–æ–≥:

```
üì¶ Processing 3 products...

[1/3] Product: 7249026173
   Title: –ú–∞—Å—Å–∞–∂–µ—Ä –¥–ª—è –≥–ª–∞–∑...
   Image: https://ir.ozone.ru/...
üîç Searching for: https://ir.ozone.ru/...
‚úÖ Found 25 similar products
üíæ Saved results to image_search_results.json
   ‚è≥ Waiting 5000ms before next search...

[2/3] Product: 1176348271
...

============================================================
‚úÖ COMPLETED!
============================================================
Total processed: 3
Success: 3
Failed: 0
Duration: 78.5s
Results saved to: image_search_results.json
============================================================
```

## –°–ª–µ–¥—É—é—â–∏–µ —à–∞–≥–∏

1. –≠–∫—Å–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞—Ç—å —Ç–æ–≤–∞—Ä—ã –∏–∑ MongoDB
2. –ó–∞–ø—É—Å—Ç–∏—Ç—å —Ç–µ—Å—Ç –Ω–∞ 5-10 —Ç–æ–≤–∞—Ä–∞—Ö
3. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã –≤ `image_search_results.json`
4. –ó–∞–ø—É—Å—Ç–∏—Ç—å –ø–æ–ª–Ω—ã–π –ø–æ–∏—Å–∫ –¥–ª—è –≤—Å–µ—Ö —Ç–æ–≤–∞—Ä–æ–≤
5. –°–æ—Ö—Ä–∞–Ω–∏—Ç—å —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã –≤ MongoDB
6. –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –¥–∞–Ω–Ω—ã–µ –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞ –∫–æ–Ω–∫—É—Ä–µ–Ω—Ç–æ–≤
